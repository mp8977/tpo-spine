<% content_for :title do %>
  TPO-spine
<% end %>

<%  require 'json'
    patId=1
    checkUp=CheckUp.where("patient_id = ?",patId).last

    #diete
    dietChecks=DietCheck.where("check_up_id = ?",checkUp.id)
    dietIds=[];
    dietChecks.each do |dietCheck|
      dietIds.push(dietCheck.diet_id)
    end
    dietNames=[]

    for el in dietIds
      dietNames.push(Diet.where("id=?",el).first.name)
    end
    dietNames=dietNames.take(5)
    dietN=dietNames.join(tag(:br))

    #alergije in bolezni
    illnessChecks=IllnessCheck.where("check_up_id = ?",checkUp.id)
    illnessIds=[];
    illnessChecks.each do |illnessCheck|
      illnessIds.push(illnessCheck.illness_id)
    end
    allergyNames=[]
    illnessNames=[]
    illnessIds.each do |el|
      diagnose=Illness.where("id=?",el).first
      if diagnose.isAllergy
        allergyNames.push(diagnose.name)
      else
        illnessNames.push(diagnose.name)
      end
    end
    allergyNames=allergyNames.take(5)
    illnessNames=illnessNames.take(5)
    allergyN=allergyNames.join(tag(:br))
    illnessN=illnessNames.join(tag(:br))


    #naslednji pregled
    nextAppointments=Appointment.where("patient_id=? AND date>=?",patId,Time.now).order('CAST(date AS DATETIME) asc').limit(10)
    nextAppointmentString=[]
    nextAppointments.each do |nextAppointment|
      nextDoctor=Doctor.where("id=?",nextAppointment.doctor_id).first
      nextDate=nextAppointment.date
      nextDateS=nextDate.hour.to_s+":"+nextDate.min.to_s+" "+nextDate.day.to_s+"/"+nextDate.month.to_s+"/"+nextDate.year.to_s
      if nextDoctor.nil?||nextAppointments.count==0
      else
        nextAppointmentString.push('Naslednji pregled <b>'+nextDateS+'</b><br>pri '+nextDoctor.category+'-u <b>'+nextDoctor.firstName+' '+nextDoctor.lastName+'</b>')
      end
    end
    #pretekli pregledi
    pastAppointments=Appointment.where("patient_id=? AND date<?",patId,Time.now).order('CAST(date AS DATETIME) DESC').limit(5)
    pastAppointmentString=[]
    pastAppointments.each do |pastAppointment|
      pastDoctor=Doctor.where("id=?",pastAppointment.doctor_id).first
      pastDate=pastAppointment.date
      pastDateS=pastDate.hour.to_s+":"+pastDate.min.to_s+" "+pastDate.day.to_s+"/"+pastDate.month.to_s+"/"+pastDate.year.to_s
      if pastDoctor.nil?||pastAppointment.nil?
      else
        pastAppointmentString.push('<tr><td>'+pastDateS+'</td><td>'+pastDoctor.category+'</td><td>'+pastDoctor.firstName+' '+pastDoctor.lastName+'</td></tr>')
      end
    end

    #zdravila
    medicineChecks=MedicineCheck.where("check_up_id = ?",checkUp.id)
    medicineIds=[];

    medicineChecks.each do |medicineCheck|
      medicineIds.push(medicineCheck.medicine_id)
    end
    medicineIds=medicineIds.take(5)

    medicineNames=[]
    medicineUrl=[]
    for el in medicineIds
      med=Medicine.where("id=?",el).first
      medicineNames.push(med.name)
      medicineUrl.push(MedicineInstruction.where("id=?",med.medicine_instruction_id).first.url)
    end

    medicineString=''
    for i in 0..medicineUrl.count
      medicineString+=("<a href='"+medicineUrl[i].to_s+"'target='_blank'>"+medicineNames[i].to_s+"</a><br />")
    end
%>

<div class="gridster">

  <ul>
    <li data-row="1" data-col="1" data-sizex="1" data-sizey="1">
      <div data-id="pat" data-view="Patient"  data-title="Pacient" ></div>
    </li>
    <%if illnessNames.count>0%>
      <li data-row="1" data-col="1" data-sizex="1" data-sizey="1">
        <div id="illness" data-view="Illness"  data-title="Bolezni" data-info="<%= illnessN %>"></div>
      </li>
    <% end %>
    <%if allergyNames.count>0%>
      <li data-row="1" data-col="1" data-sizex="1" data-sizey="1">
        <div id="allergy"  data-view="Allergy"  data-title="Alergije" data-info="<%= allergyN %>"></div>
      </li>
    <% end %>
    <%if dietNames.count>0%>
      <li data-row="1" data-col="1" data-sizex="1" data-sizey="1">
        <div id="diet"  data-view="Diet"  data-title="Diete" data-info="<%= dietN %>"></div>
      </li>
    <%end%>
    <%if nextAppointmentString.count>0%>
      <li data-row="1" data-col="1" data-sizex="2" data-sizey="1">
        <div id="nextAppointment"  data-view="Appointment"  data-title="Termini" data-info="<%= nextAppointmentString %>"></div>
      </li>
    <% end %>
    <%if pastAppointmentString.count>0%>
        <li data-row="1" data-col="1" data-sizex="2" data-sizey="1">
          <div id="pastAppointment"  data-view="Pappointments"  data-title="Pretekli pregledi" data-info="<%= pastAppointmentString %>"></div>
        </li>
    <%end%>
    <%if medicineNames.count>0%>
        <li data-row="1" data-col="1" data-sizex="1" data-sizey="1">
          <div id="medicine"  data-view="Medicine"  data-title="Zdravila" data-info="<%= medicineString %>"></div>
        </li>
    <% end %>
  </ul>
</div>

